{% extends "base.html" %}

{% block title %}Файлы — {{ panel_name }}{% endblock %}

{% block content %}
<div class="fade-in h-[calc(100vh-4rem)] flex flex-col">
    <div class="flex items-center justify-between mb-6">
        <h1 class="text-2xl font-semibold">File Manager</h1>
        <div class="flex gap-3">
            <button onclick="showCreateModal('file')" class="btn-secondary flex items-center gap-2 text-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                    </path>
                </svg>
                New File
            </button>
            <button onclick="showCreateModal('directory')" class="btn-secondary flex items-center gap-2 text-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z"></path>
                </svg>
                New Folder
            </button>
            <label class="btn-primary flex items-center gap-2 text-sm cursor-pointer">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12">
                    </path>
                </svg>
                Upload
                <input type="file" id="uploadInput" multiple class="hidden" onchange="uploadFiles(this.files)">
            </label>
        </div>
    </div>

    <!-- Breadcrumb -->
    <div class="card px-4 py-3 mb-4 flex items-center gap-2 text-sm" id="breadcrumb"></div>

    <div class="flex-1 flex gap-4 min-h-0">
        <!-- File List -->
        <div class="card w-1/3 overflow-hidden flex flex-col">
            <div class="p-4 border-b border-border">
                <h3 class="font-medium text-sm text-text-secondary">Files</h3>
            </div>
            <div id="fileList" class="flex-1 overflow-auto p-2 space-y-1"></div>
        </div>

        <!-- Editor -->
        <div class="card flex-1 flex flex-col overflow-hidden">
            <div class="flex items-center justify-between p-4 border-b border-border">
                <span id="editorTitle" class="text-sm text-text-muted">Select a file</span>
                <button id="saveBtn" onclick="saveFile()" class="hidden btn-primary py-2 px-4 text-sm">Save</button>
            </div>
            <div id="editor" class="flex-1"></div>
        </div>
    </div>
</div>

<!-- Create Modal -->
<div id="createModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-50">
    <div class="card p-6 w-full max-w-md m-4 fade-in">
        <h3 id="createModalTitle" class="text-lg font-semibold mb-4">Create New</h3>
        <input type="text" id="createName" placeholder="Enter name..." class="input w-full mb-4">
        <div class="flex gap-3 justify-end">
            <button onclick="closeCreateModal()" class="btn-secondary py-2 px-4 text-sm">Cancel</button>
            <button onclick="confirmCreate()" class="btn-primary py-2 px-4 text-sm">Create</button>
        </div>
    </div>
</div>

<!-- Context Menu -->
<div id="contextMenu" class="fixed hidden card py-2 min-w-[160px] shadow-xl z-50">
    <button onclick="renameItem()"
        class="w-full px-4 py-2 text-left text-sm hover:bg-surface-hover flex items-center gap-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z">
            </path>
        </svg>
        Rename
    </button>
    <button onclick="deleteItem()"
        class="w-full px-4 py-2 text-left text-sm hover:bg-surface-hover text-red-400 flex items-center gap-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
            </path>
        </svg>
        Delete
    </button>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentPath = '/';
    let currentFile = null;
    let monacoEditor = null;
    let createType = 'file';
    let contextItem = null;

    // Initialize Monaco
    require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs' } });
    require(['vs/editor/editor.main'], function () {
        monacoEditor = monaco.editor.create(document.getElementById('editor'), {
            value: '',
            language: 'plaintext',
            theme: 'vs-dark',
            minimap: { enabled: false },
            fontSize: 13,
            lineNumbers: 'on',
            scrollBeyondLastLine: false,
            automaticLayout: true,
            padding: { top: 16, bottom: 16 }
        });
    });

    async function loadPath(path = '/') {
        currentPath = path;
        const data = await API.get(`/files/api/list?path=${encodeURIComponent(path)}`);

        if (data.error) {
            showToast(data.error, 'error');
            return;
        }

        // Breadcrumb
        const parts = path.split('/').filter(p => p);
        let breadcrumbHtml = `<a href="#" onclick="loadPath('/')" class="text-text-muted hover:text-primary transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
        </a>`;
        let buildPath = '';
        parts.forEach(p => {
            buildPath += '/' + p;
            const bp = buildPath;
            breadcrumbHtml += `<svg class="w-4 h-4 text-text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
            <a href="#" onclick="loadPath('${bp}')" class="text-text-muted hover:text-primary transition-colors">${p}</a>`;
        });
        document.getElementById('breadcrumb').innerHTML = breadcrumbHtml;

        // File list
        let html = '';
        if (data.parent) {
            html += `<div onclick="loadPath('${data.parent}')" class="flex items-center gap-3 p-3 hover:bg-surface-hover rounded-lg cursor-pointer transition-colors">
                <svg class="w-5 h-5 text-text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12"></path></svg>
                <span class="text-text-secondary">..</span>
            </div>`;
        }

        data.items.forEach(item => {
            const icon = item.is_dir
                ? '<svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg>'
                : '<svg class="w-5 h-5 text-text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>';

            html += `<div class="flex items-center gap-3 p-3 hover:bg-surface-hover rounded-lg cursor-pointer transition-colors group" 
                      onclick="${item.is_dir ? `loadPath('${item.relative_path}')` : `openFile('${item.relative_path}')`}"
                      oncontextmenu="showContextMenu(event, '${item.relative_path}', ${item.is_dir})">
                ${icon}
                <span class="flex-1 truncate text-sm">${item.name}</span>
                <span class="text-xs text-text-muted opacity-0 group-hover:opacity-100 transition-opacity">${item.size_human}</span>
            </div>`;
        });

        document.getElementById('fileList').innerHTML = html || '<p class="text-text-muted text-sm p-4 text-center">Empty folder</p>';
    }

    async function openFile(path) {
        const data = await API.get(`/files/api/read?path=${encodeURIComponent(path)}`);
        if (data.error) {
            showToast(data.error, 'error');
            return;
        }

        currentFile = path;
        document.getElementById('editorTitle').textContent = path.split('/').pop();
        document.getElementById('saveBtn').classList.remove('hidden');

        const ext = path.split('.').pop().toLowerCase();
        const langMap = { py: 'python', js: 'javascript', ts: 'typescript', html: 'html', css: 'css', json: 'json', md: 'markdown', sh: 'shell', yml: 'yaml', yaml: 'yaml', xml: 'xml', php: 'php', sql: 'sql' };
        const lang = langMap[ext] || 'plaintext';

        monaco.editor.setModelLanguage(monacoEditor.getModel(), lang);
        monacoEditor.setValue(data.content);
    }

    async function saveFile() {
        if (!currentFile) return;
        const content = monacoEditor.getValue();
        const data = await API.post('/files/api/save', { path: currentFile, content });
        showToast(data.message || data.error, data.success ? 'success' : 'error');
    }

    function showCreateModal(type) {
        createType = type;
        document.getElementById('createModalTitle').textContent = type === 'directory' ? 'Create New Folder' : 'Create New File';
        document.getElementById('createName').value = '';
        document.getElementById('createModal').classList.remove('hidden');
        document.getElementById('createModal').classList.add('flex');
        document.getElementById('createName').focus();
    }

    function closeCreateModal() {
        document.getElementById('createModal').classList.add('hidden');
        document.getElementById('createModal').classList.remove('flex');
    }

    async function confirmCreate() {
        const name = document.getElementById('createName').value.trim();
        if (!name) {
            showToast('Please enter a name', 'error');
            return;
        }
        const data = await API.post('/files/api/create', { path: currentPath, name, type: createType });
        if (data.success) {
            showToast(data.message || 'Created successfully', 'success');
            closeCreateModal();
            loadPath(currentPath);
        } else {
            showToast(data.error, 'error');
        }
    }

    async function uploadFiles(files) {
        const formData = new FormData();
        formData.append('path', currentPath);
        for (const file of files) formData.append('files', file);

        const res = await fetch('/files/api/upload', { method: 'POST', body: formData });
        const data = await res.json();
        showToast(`Uploaded: ${data.uploaded.length} files`, 'success');
        loadPath(currentPath);
    }

    function showContextMenu(e, path, isDir) {
        e.preventDefault();
        e.stopPropagation();
        contextItem = { path, isDir };
        const menu = document.getElementById('contextMenu');
        menu.style.left = e.pageX + 'px';
        menu.style.top = e.pageY + 'px';
        menu.classList.remove('hidden');
    }

    function hideContextMenu() {
        document.getElementById('contextMenu').classList.add('hidden');
    }

    async function renameItem() {
        hideContextMenu();
        const newName = prompt('New name:', contextItem.path.split('/').pop());
        if (newName) {
            await API.post('/files/api/rename', { path: contextItem.path, new_name: newName });
            loadPath(currentPath);
        }
    }

    async function deleteItem() {
        hideContextMenu();
        if (confirm('Are you sure you want to delete this?')) {
            await API.post('/files/api/delete', { path: contextItem.path });
            loadPath(currentPath);
        }
    }

    document.addEventListener('click', hideContextMenu);
    document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
            e.preventDefault();
            saveFile();
        }
        if (e.key === 'Escape') {
            closeCreateModal();
        }
    });

    document.getElementById('createName').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') confirmCreate();
    });

    loadPath('/');
</script>
{% endblock %}