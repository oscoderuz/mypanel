{% extends "base.html" %}

{% block title %}Terminal — {{ panel_name }}{% endblock %}

{% block head %}
<style>
    #terminal-container {
        height: calc(100vh - 12rem);
    }

    .xterm {
        height: 100%;
        padding: 8px;
    }

    .xterm-viewport {
        border-radius: 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="flex items-center justify-between mb-6">
        <h1 class="text-2xl font-semibold">Terminal</h1>
        <div class="flex gap-3">
            <button onclick="reconnect()" class="btn-secondary flex items-center gap-2 text-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                    </path>
                </svg>
                Reconnect
            </button>
            <button onclick="clearTerminal()" class="btn-secondary flex items-center gap-2 text-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                    </path>
                </svg>
                Clear
            </button>
        </div>
    </div>

    <div id="status" class="card px-4 py-3 mb-4 flex items-center gap-3">
        <div id="statusDot" class="w-2 h-2 bg-indicator-warning rounded-full"></div>
        <span id="statusText" class="text-sm text-text-secondary">Connecting...</span>
    </div>

    <div class="card p-4 overflow-hidden" id="terminal-container"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let term, fitAddon, socket;

    function initTerminal() {
        term = new Terminal({
            cursorBlink: true,
            fontSize: 13,
            fontFamily: '"JetBrains Mono", "Fira Code", Menlo, Monaco, "Courier New", monospace',
            theme: {
                background: '#000000',
                foreground: '#ffffff',
                cursor: '#ffffff',
                cursorAccent: '#000000',
                selection: 'rgba(255, 255, 255, 0.2)',
                black: '#0a0a0a',
                red: '#ef4444',
                green: '#22c55e',
                yellow: '#f59e0b',
                blue: '#3b82f6',
                magenta: '#a855f7',
                cyan: '#06b6d4',
                white: '#ffffff',
                brightBlack: '#404040',
                brightRed: '#f87171',
                brightGreen: '#4ade80',
                brightYellow: '#fbbf24',
                brightBlue: '#60a5fa',
                brightMagenta: '#c084fc',
                brightCyan: '#22d3ee',
                brightWhite: '#ffffff'
            },
            allowProposedApi: true
        });

        fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);

        term.open(document.getElementById('terminal-container'));
        fitAddon.fit();

        window.addEventListener('resize', () => {
            fitAddon.fit();
            if (socket && socket.connected) {
                socket.emit('terminal_resize', { rows: term.rows, cols: term.cols });
            }
        });

        term.onData(data => {
            if (socket && socket.connected) {
                socket.emit('terminal_input', { data });
            }
        });

        connectSocket();
    }

    function connectSocket() {
        setStatus('connecting');

        socket = io({
            transports: ['websocket'],
            reconnection: true,
            reconnectionAttempts: 5,
            reconnectionDelay: 1000
        });

        socket.on('connect', () => {
            socket.emit('terminal_connect');
        });

        socket.on('terminal_ready', (data) => {
            setStatus('connected');
            term.write('\r\n\x1b[32m● Terminal connected\x1b[0m\r\n\r\n');
            fitAddon.fit();
            socket.emit('terminal_resize', { rows: term.rows, cols: term.cols });
        });

        socket.on('terminal_output', (data) => {
            term.write(data.data);
        });

        socket.on('terminal_error', (data) => {
            setStatus('error');
            term.write(`\r\n\x1b[31m✗ ${data.message}\x1b[0m\r\n`);
        });

        socket.on('disconnect', () => {
            setStatus('disconnected');
            term.write('\r\n\x1b[33m○ Connection lost\x1b[0m\r\n');
        });

        socket.on('connect_error', (err) => {
            setStatus('error');
            console.error('Socket connection error:', err);
        });
    }

    function setStatus(status) {
        const dot = document.getElementById('statusDot');
        const text = document.getElementById('statusText');

        const states = {
            connecting: { color: 'bg-indicator-warning', text: 'Connecting...' },
            connected: { color: 'bg-indicator-success animate-pulse', text: 'Connected' },
            disconnected: { color: 'bg-text-muted', text: 'Disconnected' },
            error: { color: 'bg-indicator-error', text: 'Connection error' }
        };

        const state = states[status] || states.disconnected;
        dot.className = `w-2 h-2 rounded-full ${state.color}`;
        text.textContent = state.text;
    }

    function reconnect() {
        if (socket) socket.disconnect();
        term.clear();
        term.write('\x1b[33m○ Reconnecting...\x1b[0m\r\n');
        connectSocket();
    }

    function clearTerminal() {
        term.clear();
    }

    initTerminal();
</script>
{% endblock %}