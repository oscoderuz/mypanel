{% extends "base.html" %}

{% block title %}Docker Store â€” {{ panel_name }}{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="flex items-center justify-between mb-6">
        <h1 class="text-2xl font-semibold">Docker Store</h1>
        <a href="{{ url_for('docker.containers') }}" class="btn-primary flex items-center gap-2 text-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path>
            </svg>
            My Containers
        </a>
    </div>

    <!-- Search -->
    <div class="card p-6 mb-6">
        <div class="flex gap-4">
            <input type="text" id="searchInput" placeholder="Search Docker Hub images..." class="input flex-1">
            <button onclick="searchImages()" class="btn-primary px-6">Search</button>
        </div>
    </div>

    <!-- Results -->
    <div id="results" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>

    <!-- Loading -->
    <div id="loading" class="hidden text-center py-16">
        <div class="inline-block w-8 h-8 border-2 border-primary border-t-transparent rounded-full animate-spin"></div>
        <p class="mt-4 text-text-muted text-sm">Searching...</p>
    </div>

    <!-- Empty state -->
    <div id="emptyState" class="text-center py-16">
        <svg class="w-16 h-16 mx-auto text-text-muted mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1"
                d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
        </svg>
        <p class="text-text-muted">Search for Docker images to get started</p>
    </div>
</div>

<!-- Install Modal -->
<div id="installModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-50">
    <div class="card p-6 w-full max-w-lg m-4 fade-in max-h-[90vh] overflow-auto">
        <h3 class="text-lg font-semibold mb-6">Deploy Container</h3>
        <form id="installForm" class="space-y-4">
            <input type="hidden" id="installImage">

            <div>
                <label class="block text-sm text-text-secondary mb-2">Container Name</label>
                <input type="text" id="containerName" required class="input w-full">
            </div>

            <div>
                <label class="block text-sm text-text-secondary mb-2">Tag</label>
                <select id="imageTag" class="input w-full">
                    <option value="latest">latest</option>
                </select>
            </div>

            <div>
                <label class="block text-sm text-text-secondary mb-2">Port Mapping (host:container)</label>
                <input type="text" id="portMapping" placeholder="8080:80" class="input w-full">
            </div>

            <div>
                <label class="block text-sm text-text-secondary mb-2">Volume Mounts (host:container)</label>
                <input type="text" id="volumeMapping" placeholder="/data:/app/data" class="input w-full">
            </div>

            <div>
                <label class="block text-sm text-text-secondary mb-2">Environment Variables</label>
                <textarea id="envVars" rows="3" placeholder="KEY=value" class="input w-full resize-none"></textarea>
            </div>

            <div id="pullProgress" class="hidden">
                <div class="progress-bar mb-2">
                    <div id="progressBar" class="progress-bar-fill" style="width: 0%"></div>
                </div>
                <p id="progressText" class="text-sm text-text-muted">Preparing...</p>
            </div>

            <div class="flex gap-3 pt-4">
                <button type="button" onclick="closeModal()" class="btn-secondary flex-1 py-3">Cancel</button>
                <button type="submit" id="installBtn" class="btn-primary flex-1 py-3">Deploy</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.getElementById('searchInput').addEventListener('keypress', e => { if (e.key === 'Enter') searchImages(); });

    async function searchImages() {
        const query = document.getElementById('searchInput').value.trim();
        if (!query) return;

        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('emptyState').classList.add('hidden');
        document.getElementById('results').innerHTML = '';

        try {
            const data = await API.get(`/docker/api/search?q=${encodeURIComponent(query)}`);
            document.getElementById('loading').classList.add('hidden');

            if (data.error) {
                showToast(data.error, 'error');
                document.getElementById('emptyState').classList.remove('hidden');
                return;
            }

            if (data.results.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
                document.getElementById('emptyState').innerHTML = `
                    <svg class="w-16 h-16 mx-auto text-text-muted mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <p class="text-text-muted">No images found for "${query}"</p>
                `;
                return;
            }

            const html = data.results.map(img => `
                <div class="card p-5 hover:border-border-light transition-colors">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex-1 min-w-0">
                            <h3 class="font-semibold truncate">${img.name}</h3>
                            ${img.is_official ? '<span class="badge badge-info mt-1">Official</span>' : ''}
                        </div>
                        <div class="flex items-center gap-1 text-yellow-400 ml-2">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                            <span class="text-sm">${img.stars}</span>
                        </div>
                    </div>
                    <p class="text-sm text-text-muted mb-4 line-clamp-2">${img.description || 'No description'}</p>
                    <button onclick="openInstall('${img.name}')" class="btn-primary w-full py-2 text-sm">Deploy</button>
                </div>
            `).join('');

            document.getElementById('results').innerHTML = html;
        } catch (e) {
            document.getElementById('loading').classList.add('hidden');
            showToast('Search error', 'error');
            document.getElementById('emptyState').classList.remove('hidden');
        }
    }

    async function openInstall(image) {
        document.getElementById('installImage').value = image;
        document.getElementById('containerName').value = image.split('/').pop().replace(/[^a-z0-9]/gi, '-');
        document.getElementById('installModal').classList.remove('hidden');
        document.getElementById('installModal').classList.add('flex');

        try {
            const data = await API.get(`/docker/api/tags/${image}`);
            const select = document.getElementById('imageTag');
            select.innerHTML = data.tags.map(t => `<option value="${t}">${t}</option>`).join('');
        } catch (e) { }
    }

    function closeModal() {
        document.getElementById('installModal').classList.add('hidden');
        document.getElementById('installModal').classList.remove('flex');
        document.getElementById('pullProgress').classList.add('hidden');
    }

    document.getElementById('installForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const image = document.getElementById('installImage').value;
        const tag = document.getElementById('imageTag').value;
        const name = document.getElementById('containerName').value;
        const portsStr = document.getElementById('portMapping').value;
        const volumesStr = document.getElementById('volumeMapping').value;
        const envStr = document.getElementById('envVars').value;

        const ports = {};
        if (portsStr) {
            portsStr.split(',').forEach(p => {
                const [host, container] = p.trim().split(':');
                if (host && container) ports[container.includes('/') ? container : `${container}/tcp`] = parseInt(host);
            });
        }

        const volumes = volumesStr ? volumesStr.split(',').map(v => v.trim()).filter(v => v) : [];

        const environment = {};
        if (envStr) {
            envStr.split('\n').forEach(line => {
                const [key, ...val] = line.split('=');
                if (key && val.length) environment[key.trim()] = val.join('=').trim();
            });
        }

        document.getElementById('pullProgress').classList.remove('hidden');
        document.getElementById('installBtn').disabled = true;
        document.getElementById('progressText').textContent = 'Pulling image...';

        try {
            await API.post('/docker/api/images/pull', { image, tag });
            document.getElementById('progressBar').style.width = '50%';
            document.getElementById('progressText').textContent = 'Creating container...';

            const result = await API.post('/docker/api/containers', {
                image: `${image}:${tag}`,
                name,
                ports,
                volumes,
                environment
            });

            if (result.success) {
                document.getElementById('progressBar').style.width = '100%';
                showToast('Container deployed!', 'success');
                setTimeout(() => { closeModal(); window.location.href = '/docker/containers'; }, 1000);
            } else {
                showToast(result.error, 'error');
                document.getElementById('pullProgress').classList.add('hidden');
                document.getElementById('installBtn').disabled = false;
            }
        } catch (e) {
            showToast('Deployment error', 'error');
            document.getElementById('pullProgress').classList.add('hidden');
            document.getElementById('installBtn').disabled = false;
        }
    });

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeModal();
    });
</script>
{% endblock %}