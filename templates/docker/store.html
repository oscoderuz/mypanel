{% extends "base.html" %}

{% block title %}Docker Store — {{ panel_name }}{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="flex items-center justify-between mb-8">
        <h1 class="text-3xl font-bold">Docker Store</h1>
        <a href="{{ url_for('docker.containers') }}" class="btn-primary px-6 py-2 rounded-xl">Мои контейнеры</a>
    </div>

    <!-- Search -->
    <div class="glass rounded-2xl p-6 mb-8">
        <div class="flex gap-4">
            <input type="text" id="searchInput" placeholder="Поиск образов в Docker Hub..."
                class="flex-1 px-4 py-3 rounded-xl bg-white/5 border border-white/10 focus:border-indigo-500 outline-none">
            <button onclick="searchImages()" class="btn-primary px-8 py-3 rounded-xl">Поиск</button>
        </div>
    </div>

    <!-- Results -->
    <div id="results" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

    <!-- Loading -->
    <div id="loading" class="hidden text-center py-12">
        <div class="inline-block w-8 h-8 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin">
        </div>
        <p class="mt-4 text-gray-400">Поиск...</p>
    </div>
</div>

<!-- Install Modal -->
<div id="installModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50">
    <div class="glass-strong rounded-2xl p-8 w-full max-w-lg m-4 fade-in">
        <h3 class="text-xl font-bold mb-6">Установка образа</h3>
        <form id="installForm" class="space-y-4">
            <input type="hidden" id="installImage">

            <div>
                <label class="block text-sm text-gray-400 mb-2">Имя контейнера</label>
                <input type="text" id="containerName" required
                    class="w-full px-4 py-2 rounded-xl bg-white/5 border border-white/10 focus:border-indigo-500 outline-none">
            </div>

            <div>
                <label class="block text-sm text-gray-400 mb-2">Тег</label>
                <select id="imageTag"
                    class="w-full px-4 py-2 rounded-xl bg-white/5 border border-white/10 focus:border-indigo-500 outline-none">
                    <option value="latest">latest</option>
                </select>
            </div>

            <div>
                <label class="block text-sm text-gray-400 mb-2">Порты (host:container)</label>
                <input type="text" id="portMapping" placeholder="8080:80"
                    class="w-full px-4 py-2 rounded-xl bg-white/5 border border-white/10 focus:border-indigo-500 outline-none">
            </div>

            <div>
                <label class="block text-sm text-gray-400 mb-2">Volumes (host:container)</label>
                <input type="text" id="volumeMapping" placeholder="/data:/app/data"
                    class="w-full px-4 py-2 rounded-xl bg-white/5 border border-white/10 focus:border-indigo-500 outline-none">
            </div>

            <div>
                <label class="block text-sm text-gray-400 mb-2">Env переменные (KEY=value, по одной)</label>
                <textarea id="envVars" rows="3" placeholder="DB_HOST=localhost"
                    class="w-full px-4 py-2 rounded-xl bg-white/5 border border-white/10 focus:border-indigo-500 outline-none"></textarea>
            </div>

            <div id="pullProgress" class="hidden">
                <div class="h-2 bg-white/10 rounded-full overflow-hidden mb-2">
                    <div id="progressBar" class="h-full bg-gradient-to-r from-indigo-500 to-purple-500 transition-all"
                        style="width: 0%"></div>
                </div>
                <p id="progressText" class="text-sm text-gray-400">Подготовка...</p>
            </div>

            <div class="flex gap-4 pt-4">
                <button type="button" onclick="closeModal()"
                    class="flex-1 px-6 py-3 rounded-xl bg-white/10 hover:bg-white/20 transition">Отмена</button>
                <button type="submit" id="installBtn" class="flex-1 btn-primary py-3 rounded-xl">Установить</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.getElementById('searchInput').addEventListener('keypress', e => { if (e.key === 'Enter') searchImages(); });

    async function searchImages() {
        const query = document.getElementById('searchInput').value.trim();
        if (!query) return;

        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('results').innerHTML = '';

        try {
            const data = await API.get(`/docker/api/search?q=${encodeURIComponent(query)}`);
            document.getElementById('loading').classList.add('hidden');

            if (data.error) {
                showToast(data.error, 'error');
                return;
            }

            const html = data.results.map(img => `
            <div class="glass rounded-2xl p-6 card-hover transition-all">
                <div class="flex items-start justify-between mb-4">
                    <div>
                        <h3 class="font-bold">${img.name}</h3>
                        ${img.is_official ? '<span class="text-xs px-2 py-1 bg-blue-500/20 text-blue-400 rounded-full">Official</span>' : ''}
                    </div>
                    <div class="flex items-center gap-1 text-yellow-400">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                        <span class="text-sm">${img.stars}</span>
                    </div>
                </div>
                <p class="text-sm text-gray-400 mb-4 line-clamp-2">${img.description || 'Нет описания'}</p>
                <button onclick="openInstall('${img.name}')" class="w-full btn-primary py-2 rounded-xl text-sm">Установить</button>
            </div>
        `).join('');

            document.getElementById('results').innerHTML = html || '<p class="text-gray-400 col-span-3 text-center py-12">Ничего не найдено</p>';
        } catch (e) {
            document.getElementById('loading').classList.add('hidden');
            showToast('Ошибка поиска', 'error');
        }
    }

    async function openInstall(image) {
        document.getElementById('installImage').value = image;
        document.getElementById('containerName').value = image.split('/').pop().replace(/[^a-z0-9]/gi, '-');
        document.getElementById('installModal').classList.remove('hidden');
        document.getElementById('installModal').classList.add('flex');

        // Load tags
        try {
            const data = await API.get(`/docker/api/tags/${image}`);
            const select = document.getElementById('imageTag');
            select.innerHTML = data.tags.map(t => `<option value="${t}">${t}</option>`).join('');
        } catch (e) { }
    }

    function closeModal() {
        document.getElementById('installModal').classList.add('hidden');
        document.getElementById('installModal').classList.remove('flex');
        document.getElementById('pullProgress').classList.add('hidden');
    }

    document.getElementById('installForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const image = document.getElementById('installImage').value;
        const tag = document.getElementById('imageTag').value;
        const name = document.getElementById('containerName').value;
        const portsStr = document.getElementById('portMapping').value;
        const volumesStr = document.getElementById('volumeMapping').value;
        const envStr = document.getElementById('envVars').value;

        // Parse ports
        const ports = {};
        if (portsStr) {
            portsStr.split(',').forEach(p => {
                const [host, container] = p.trim().split(':');
                if (host && container) ports[container.includes('/') ? container : `${container}/tcp`] = parseInt(host);
            });
        }

        // Parse volumes
        const volumes = volumesStr ? volumesStr.split(',').map(v => v.trim()).filter(v => v) : [];

        // Parse env
        const environment = {};
        if (envStr) {
            envStr.split('\n').forEach(line => {
                const [key, ...val] = line.split('=');
                if (key && val.length) environment[key.trim()] = val.join('=').trim();
            });
        }

        document.getElementById('pullProgress').classList.remove('hidden');
        document.getElementById('installBtn').disabled = true;
        document.getElementById('progressText').textContent = 'Загрузка образа...';

        try {
            // Pull image
            await API.post('/docker/api/images/pull', { image, tag });
            document.getElementById('progressBar').style.width = '50%';
            document.getElementById('progressText').textContent = 'Создание контейнера...';

            // Create container
            const result = await API.post('/docker/api/containers', {
                image: `${image}:${tag}`,
                name,
                ports,
                volumes,
                environment
            });

            if (result.success) {
                document.getElementById('progressBar').style.width = '100%';
                showToast('Контейнер создан!', 'success');
                setTimeout(() => { closeModal(); window.location.href = '/docker/containers'; }, 1000);
            } else {
                showToast(result.error, 'error');
                document.getElementById('pullProgress').classList.add('hidden');
                document.getElementById('installBtn').disabled = false;
            }
        } catch (e) {
            showToast('Ошибка установки', 'error');
            document.getElementById('pullProgress').classList.add('hidden');
            document.getElementById('installBtn').disabled = false;
        }
    });
</script>
{% endblock %}