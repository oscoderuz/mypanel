{% extends "base.html" %}

{% block title %}Контейнеры — {{ panel_name }}{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="flex items-center justify-between mb-8">
        <h1 class="text-3xl font-bold">Контейнеры</h1>
        <a href="{{ url_for('docker.store') }}" class="btn-primary px-6 py-2 rounded-xl">Docker Store</a>
    </div>

    <div id="containers" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

    <div id="empty" class="hidden text-center py-16">
        <div class="w-20 h-20 mx-auto mb-6 rounded-full bg-indigo-500/20 flex items-center justify-center">
            <svg class="w-10 h-10 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path>
            </svg>
        </div>
        <h3 class="text-xl font-bold mb-2">Нет контейнеров</h3>
        <p class="text-gray-400 mb-6">Установите приложение из Docker Store</p>
        <a href="{{ url_for('docker.store') }}" class="btn-primary px-6 py-3 rounded-xl inline-block">Открыть Store</a>
    </div>
</div>

<!-- Logs Modal -->
<div id="logsModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50">
    <div class="glass-strong rounded-2xl p-6 w-full max-w-4xl m-4 max-h-[80vh] flex flex-col">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold">Логи: <span id="logsTitle">-</span></h3>
            <button onclick="closeLogsModal()" class="p-2 hover:bg-white/10 rounded-lg">&times;</button>
        </div>
        <pre id="logsContent"
            class="flex-1 overflow-auto bg-black/50 rounded-xl p-4 text-sm font-mono text-green-400"></pre>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function loadContainers() {
        try {
            const data = await API.get('/docker/api/containers');
            const containers = data.containers || [];

            if (containers.length === 0) {
                document.getElementById('containers').innerHTML = '';
                document.getElementById('empty').classList.remove('hidden');
                return;
            }

            document.getElementById('empty').classList.add('hidden');

            const html = containers.map(c => {
                const isRunning = c.status === 'running';
                const statusColor = isRunning ? 'bg-green-500' : 'bg-gray-500';

                return `
                <div class="glass rounded-2xl p-6 card-hover transition-all">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-3 h-3 ${statusColor} rounded-full ${isRunning ? 'animate-pulse' : ''}"></div>
                            <div>
                                <h3 class="font-bold">${c.name}</h3>
                                <p class="text-xs text-gray-400">${c.image}</p>
                            </div>
                        </div>
                        <span class="text-xs px-2 py-1 rounded-full ${isRunning ? 'bg-green-500/20 text-green-400' : 'bg-gray-500/20 text-gray-400'}">${c.status}</span>
                    </div>
                    
                    <div class="text-sm text-gray-400 mb-4">
                        ${c.ports.length ? `<p>Порты: ${c.ports.join(', ')}</p>` : '<p class="text-gray-500">Нет открытых портов</p>'}
                    </div>
                    
                    <div class="flex flex-wrap gap-2">
                        ${isRunning ? `
                            <button onclick="stopContainer('${c.id}')" class="px-3 py-1 text-sm bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded-lg transition">Стоп</button>
                            <button onclick="restartContainer('${c.id}')" class="px-3 py-1 text-sm bg-yellow-500/20 hover:bg-yellow-500/30 text-yellow-400 rounded-lg transition">Рестарт</button>
                        ` : `
                            <button onclick="startContainer('${c.id}')" class="px-3 py-1 text-sm bg-green-500/20 hover:bg-green-500/30 text-green-400 rounded-lg transition">Старт</button>
                        `}
                        <button onclick="showLogs('${c.id}', '${c.name}')" class="px-3 py-1 text-sm bg-indigo-500/20 hover:bg-indigo-500/30 text-indigo-400 rounded-lg transition">Логи</button>
                        <button onclick="deleteContainer('${c.id}')" class="px-3 py-1 text-sm bg-white/10 hover:bg-white/20 text-gray-400 rounded-lg transition">Удалить</button>
                    </div>
                </div>
            `;
            }).join('');

            document.getElementById('containers').innerHTML = html;
        } catch (e) {
            console.error(e);
        }
    }

    async function startContainer(id) {
        const res = await API.post(`/docker/api/containers/${id}/start`);
        showToast(res.message || res.error, res.success ? 'success' : 'error');
        loadContainers();
    }

    async function stopContainer(id) {
        const res = await API.post(`/docker/api/containers/${id}/stop`);
        showToast(res.message || res.error, res.success ? 'success' : 'error');
        loadContainers();
    }

    async function restartContainer(id) {
        const res = await API.post(`/docker/api/containers/${id}/restart`);
        showToast(res.message || res.error, res.success ? 'success' : 'error');
        loadContainers();
    }

    async function deleteContainer(id) {
        if (!confirm('Удалить контейнер?')) return;
        const res = await API.delete(`/docker/api/containers/${id}?force=true`);
        showToast(res.message || res.error, res.success ? 'success' : 'error');
        loadContainers();
    }

    async function showLogs(id, name) {
        document.getElementById('logsTitle').textContent = name;
        document.getElementById('logsContent').textContent = 'Загрузка...';
        document.getElementById('logsModal').classList.remove('hidden');
        document.getElementById('logsModal').classList.add('flex');

        const data = await API.get(`/docker/api/containers/${id}/logs?tail=200`);
        document.getElementById('logsContent').textContent = data.logs || 'Нет логов';
    }

    function closeLogsModal() {
        document.getElementById('logsModal').classList.add('hidden');
        document.getElementById('logsModal').classList.remove('flex');
    }

    loadContainers();
    setInterval(loadContainers, 10000);
</script>
{% endblock %}