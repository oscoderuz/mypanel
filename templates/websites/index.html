{% extends "base.html" %}

{% block title %}Сайты — {{ panel_name }}{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="flex items-center justify-between mb-8">
        <h1 class="text-3xl font-bold">Управление сайтами</h1>
        <button onclick="openAddDomain()" class="btn-primary px-6 py-2 rounded-xl">Добавить домен</button>
    </div>

    <!-- Nginx Status -->
    <div class="glass rounded-2xl p-4 mb-6 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <div id="nginxStatus" class="w-3 h-3 bg-gray-500 rounded-full"></div>
            <span>Nginx: <span id="nginxStatusText">Проверка...</span></span>
        </div>
        <div class="flex gap-2">
            <button onclick="reloadNginx()"
                class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-sm transition">Reload</button>
            <button onclick="testNginx()"
                class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-sm transition">Test Config</button>
        </div>
    </div>

    <div id="domains" class="space-y-4"></div>

    <div id="empty" class="hidden text-center py-16">
        <div class="w-20 h-20 mx-auto mb-6 rounded-full bg-indigo-500/20 flex items-center justify-center">
            <svg class="w-10 h-10 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9">
                </path>
            </svg>
        </div>
        <h3 class="text-xl font-bold mb-2">Нет доменов</h3>
        <p class="text-gray-400">Добавьте первый домен</p>
    </div>
</div>

<!-- Add Domain Modal -->
<div id="addModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50">
    <div class="glass-strong rounded-2xl p-8 w-full max-w-lg m-4">
        <h3 class="text-xl font-bold mb-6">Добавить домен</h3>
        <form id="addForm" class="space-y-4">
            <div>
                <label class="block text-sm text-gray-400 mb-2">Доменное имя</label>
                <input type="text" id="domainName" required placeholder="example.com"
                    class="w-full px-4 py-2 rounded-xl bg-white/5 border border-white/10 focus:border-indigo-500 outline-none">
            </div>

            <div>
                <label class="block text-sm text-gray-400 mb-2">Тип</label>
                <select id="proxyType"
                    class="w-full px-4 py-2 rounded-xl bg-white/5 border border-white/10 outline-none">
                    <option value="reverse_proxy">Reverse Proxy</option>
                    <option value="static">Static Site</option>
                </select>
            </div>

            <div id="portField">
                <label class="block text-sm text-gray-400 mb-2">Порт приложения</label>
                <input type="number" id="targetPort" placeholder="3000"
                    class="w-full px-4 py-2 rounded-xl bg-white/5 border border-white/10 outline-none">
            </div>

            <div id="pathField" class="hidden">
                <label class="block text-sm text-gray-400 mb-2">Путь к файлам</label>
                <input type="text" id="rootPath" placeholder="/var/www/site"
                    class="w-full px-4 py-2 rounded-xl bg-white/5 border border-white/10 outline-none">
            </div>

            <div class="flex gap-4 pt-4">
                <button type="button" onclick="closeAddModal()"
                    class="flex-1 px-6 py-3 rounded-xl bg-white/10 hover:bg-white/20 transition">Отмена</button>
                <button type="submit" class="flex-1 btn-primary py-3 rounded-xl">Добавить</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.getElementById('proxyType').addEventListener('change', (e) => {
        document.getElementById('portField').classList.toggle('hidden', e.target.value !== 'reverse_proxy');
        document.getElementById('pathField').classList.toggle('hidden', e.target.value !== 'static');
    });

    async function loadDomains() {
        const data = await API.get('/websites/api/domains');
        const domains = data.domains || [];

        if (domains.length === 0) {
            document.getElementById('domains').innerHTML = '';
            document.getElementById('empty').classList.remove('hidden');
            return;
        }

        document.getElementById('empty').classList.add('hidden');

        const html = domains.map(d => `
        <div class="glass rounded-2xl p-6 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-xl ${d.ssl_enabled ? 'bg-green-500/20' : 'bg-gray-500/20'} flex items-center justify-center">
                    ${d.ssl_enabled ? '<svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>' : '<svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"></path></svg>'}
                </div>
                <div>
                    <h3 class="font-bold">${d.domain_name}</h3>
                    <p class="text-sm text-gray-400">${d.proxy_type === 'reverse_proxy' ? `→ localhost:${d.target_port}` : d.root_path}</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                ${!d.ssl_enabled ? `<button onclick="issueSSL(${d.id})" class="px-4 py-2 bg-green-500/20 hover:bg-green-500/30 text-green-400 rounded-lg text-sm transition">SSL</button>` : ''}
                <button onclick="deleteDomain(${d.id})" class="px-4 py-2 bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded-lg text-sm transition">Удалить</button>
            </div>
        </div>
    `).join('');

        document.getElementById('domains').innerHTML = html;
    }

    async function checkNginxStatus() {
        const data = await API.get('/websites/api/nginx/status');
        document.getElementById('nginxStatus').className = `w-3 h-3 rounded-full ${data.running ? 'bg-green-500 animate-pulse' : 'bg-red-500'}`;
        document.getElementById('nginxStatusText').textContent = data.running ? 'Запущен' : 'Остановлен';
    }

    function openAddDomain() {
        document.getElementById('addModal').classList.remove('hidden');
        document.getElementById('addModal').classList.add('flex');
    }

    function closeAddModal() {
        document.getElementById('addModal').classList.add('hidden');
        document.getElementById('addModal').classList.remove('flex');
    }

    document.getElementById('addForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = {
            domain_name: document.getElementById('domainName').value,
            proxy_type: document.getElementById('proxyType').value,
            target_port: document.getElementById('targetPort').value,
            root_path: document.getElementById('rootPath').value
        };

        const res = await API.post('/websites/api/domains', data);
        if (res.success) {
            showToast('Домен добавлен', 'success');
            closeAddModal();
            loadDomains();
        } else {
            showToast(res.error, 'error');
        }
    });

    async function issueSSL(id) {
        if (!confirm('Выпустить SSL сертификат?')) return;
        showToast('Выпуск сертификата...', 'info');
        const res = await API.post(`/websites/api/domains/${id}/ssl`);
        showToast(res.message || res.error, res.success ? 'success' : 'error');
        loadDomains();
    }

    async function deleteDomain(id) {
        if (!confirm('Удалить домен?')) return;
        const res = await API.delete(`/websites/api/domains/${id}`);
        showToast(res.message || res.error, res.success ? 'success' : 'error');
        loadDomains();
    }

    async function reloadNginx() {
        const res = await API.post('/websites/api/nginx/reload');
        showToast(res.message || res.error, res.success ? 'success' : 'error');
        checkNginxStatus();
    }

    async function testNginx() {
        const res = await API.get('/websites/api/nginx/test');
        showToast(res.message || res.error, res.success ? 'success' : 'error');
    }

    loadDomains();
    checkNginxStatus();
</script>
{% endblock %}